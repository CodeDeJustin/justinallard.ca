name: CI

on:
  push:
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect package manager
        id: detect
        shell: bash
        run: |
          if [[ -f pnpm-lock.yaml ]]; then
            echo "manager=pnpm" >> "$GITHUB_OUTPUT"
            echo "install=pnpm install --frozen-lockfile" >> "$GITHUB_OUTPUT"
            echo "run=pnpm" >> "$GITHUB_OUTPUT"
          elif [[ -f yarn.lock ]]; then
            echo "manager=yarn" >> "$GITHUB_OUTPUT"
            echo "install=yarn install --frozen-lockfile" >> "$GITHUB_OUTPUT"
            echo "run=yarn" >> "$GITHUB_OUTPUT"
          elif [[ -f package-lock.json ]]; then
            echo "manager=npm" >> "$GITHUB_OUTPUT"
            echo "install=npm ci" >> "$GITHUB_OUTPUT"
            echo "run=npm" >> "$GITHUB_OUTPUT"
          else
            echo "manager=npm" >> "$GITHUB_OUTPUT"
            echo "install=npm install" >> "$GITHUB_OUTPUT"
            echo "run=npm" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: ${{ steps.detect.outputs.manager }}
          cache-dependency-path: |
            pnpm-lock.yaml
            yarn.lock
            package-lock.json

      - name: Setup pnpm via Corepack
        if: ${{ steps.detect.outputs.manager == 'pnpm' }}
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate
          pnpm --version

      - name: Enable Corepack for yarn
        if: ${{ steps.detect.outputs.manager == 'yarn' }}
        run: corepack enable

      - name: Install dependencies
        run: ${{ steps.detect.outputs.install }}

      - name: Run lint
        shell: bash
        run: |
          if node -e "const pkg=require('./package.json'); process.exit(pkg.scripts && pkg.scripts.lint ? 0 : 1)"; then
            ${{ steps.detect.outputs.run }} lint
          else
            echo "No lint script found, skipping."
          fi

      - name: Run tests
        shell: bash
        run: |
          if node -e "const pkg=require('./package.json'); process.exit(pkg.scripts && pkg.scripts.test ? 0 : 1)"; then
            ${{ steps.detect.outputs.run }} test
          else
            echo "No test script found, skipping."
          fi

      - name: Run build
        shell: bash
        run: |
          if node -e "const pkg=require('./package.json'); process.exit(pkg.scripts && pkg.scripts.build ? 0 : 1)"; then
            ${{ steps.detect.outputs.run }} build
          else
            echo "No build script found, skipping."
          fi
